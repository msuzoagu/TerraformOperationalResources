AWSTemplateFormatVersion: '2010-09-09'
Description: create role users must assume to run Terraform commands

Parameters: 
  ListOfStateBucketArns:
    Type: CommaDelimitedList
    Description: >-
    comma-delimited list of exported state bucket arns backendRole 
    is granted access to
  ListOfLockTableArns:
    Type: CommaDelimitedList
    Description: >-
    comma-delimited list of exported lock table arns backendRole
    is granted access to
  PolicyName:
    Type: String
  ValueOfUserTag:
    Type: String
  SessionDuration:
    Type: String
  UserMgtAccountId:
    Type: String
  TerraformAccountId:
    Type: String
  BackendRole: 
    Type: String 

Rules:
  Deployment:
    Assertions:
      - Assert: !Equals
        - !Ref AWS::AccountId
        - !Ref TerraformAccountId #TrustingAccount
        AssertDescription: "resources must be created in Terraform account"

Resources:
  Role: 
    Type: 'AWS::IAM::Role'
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Properties: 
      RoleName: !Ref BackendRole
      Description: assume role to run Terraform commands
      MaxSessionDuration: !Ref SessionDuration
      ManagedPolicyArns:
        - !Ref RolePolicy
      AssumeRolePolicyDocument: #trust policy for role
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal: 
              AWS: !Ref UserMgtAccountId #TrustedAccount
            Action:
              - 'sts:AssumeRole'
            Condition:
              Bool: # must authenticate via mfa to assume role
                aws:MultiFactorAuthPresent: true
              StringEquals:
                aws:PrincipalType:
                  - "User"
              StringLike:
                aws:PrincipalTag/Terraformers:
                  - !Ref ValueOfUserTag
                sts:RoleSessionName:
                  - '${aws:username}'
  RolePolicy:
    Type: 'AWS::IAM::ManagedPolicy'
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Properties: 
      ManagedPolicyName: !Ref PolicyName 
      Description: !Sub "permissions for ${BackendRole}"
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: AllowStateBucketList
            Effect: Allow
            Action: 
              - 's3:ListBucket'
              - 's3:GetBucketVersioning'
            Resource:
              - Fn::ImportValue: !Select [0, !Ref BucketList]
              - Fn::ImportValue: !Select [1, !Ref BucketList]
              - Fn::ImportValue: !Select [2, !Ref BucketList]

          - Sid: AllowStateReadWrite
            Effect: Allow
            Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Resource: 
              - !Join 
                - ''
                - - Fn::ImportValue: !Select [0, !Ref BucketList]
                  - /*
              - !Join 
                - ''
                - - Fn::ImportValue: !Select [1, !Ref BucketList]
                  - /*
              - !Join 
                - ''
                - - Fn::ImportValue: !Select [2, !Ref BucketList]
                  - /*
          - Sid: AllowStateLockReadWrite
            Effect: Allow
            Action:
              - 'dynamodb:DescribeTable'
              - 'dynamodb:GetItem'
              - 'dynamodb:PutItem'
              - 'dynamodb:DeleteItem'  
              - 'dynamodb:ListTagsOfResource'
            Resource: 
              - !Join 
                - ''
                - - Fn::ImportValue: !Select [0, !Ref LockTableList]
                  - /*
              - !Join
                - ''
                - - Fn::ImportValue: !Select [1, !Ref LockTableList]
                  - /*
              - !Join
                - ''
                - - Fn::ImportValue: !Select [2, !Ref LockTableList]
                  - /*


Outputs:
  RoleId:
    Description: id of role
    Value: !GetAtt Role.RoleId
    Export:
      Name: 
        "BackendRoleId"